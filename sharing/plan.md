# Jetson実走行に向けた学習・推論改善プラン（報酬関数以外）

## 目的
- 既存の **train.py + PPO** 構成を前提に、
- **報酬関数を変更せず** に
- 学習の安定性（loss暴れ対策）と実走行性能（Jetson + LiDAR）を改善する。

本プランは、教員アドバイスで言及された **「残差処理」「action」「時間」** を軸に整理する。

---

## 前提状況（現状整理）

- 環境: f1tenth_gym / F1TenthRL（独自ラッパ）
- アルゴリズム: PPO (stable-baselines3)
- 観測: LiDAR（現状は 540次元未満）
- 問題点:
  - 学習ステップを増やすと **loss が発散・振動** しやすい
  - シミュレーションでは動くが、実走行で不安定になりがち

---

## 改善方針 全体像

| 観点 | 改善カテゴリ | 目的 |
|---|---|---|
| 観測 | 残差処理（Observation） | 状態変化を明示し学習を安定化 |
| 行動 | Action設計 | 出力の急変・振動を防ぐ |
| 時間 | 時系列構造 | 将来を見越した操作を学習させる |
| 学習 | PPO安定化 | loss暴れ・過学習の抑制 |

---

## 1. 残差処理（Observation側）【最重要】

### 1.1 残差処理とは

- **現在値そのもの**ではなく、
- **前ステップとの差分（Δ）** を観測に含める設計

例：
```
obs = [
  lidar_t,
  lidar_t - lidar_{t-1},
  speed_t,
  speed_t - speed_{t-1}
]
```

### 1.2 なぜ LiDAR は 540次元必要か

- LiDARを低次元（例: 108, 180）に圧縮すると：
  - 差分計算後に**情報量が急激に減少**
  - 障害物エッジ・コーナー形状が消失

- 540次元を維持することで：
  - 残差（ΔLiDAR）も十分な空間分解能を保持
  - 壁接近・開空間変化を学習可能

**結論:**
> 残差処理前提なら LiDAR=540次元は必須

### 1.3 実装ポイント

- F1TenthRL 内で
  - `prev_lidar` を保持
  - reset時は Δ=0 で初期化

---

## 2. Action設計の改善（actionの残差化）

### 2.1 問題点

- PPOは連続値を直接出力
- 実機では：
  - ステア角・速度の**急変＝即スピン**

### 2.2 Action残差化

**方針:**
- ポリシーは「変化量」だけを出力

```
steer_t = steer_{t-1} + Δsteer
speed_t = speed_{t-1} + Δspeed
```

### 2.3 効果

- action空間が事実上「低周波」になる
- lossの急変が抑制されやすい
- 実走行の操舵が滑らかになる

---

## 3. 時間構造の導入（教員キーワード: 時間）

### 3.1 Frame Stack

- 単発観測では「接近中」か「遠ざかり中」か区別不可
- 対策：

```
obs_t = [obs_{t}, obs_{t-1}, obs_{t-2}]
```

- stable-baselines3:
  - `VecFrameStack` 使用可能

### 3.2 時間情報の明示

- 観測に以下を追加:
  - 経過ステップ数 / 最大ステップ
  - lap進捗率

→ コース後半での速度戦略を学習可能

---

## 4. PPO学習安定化（loss暴れ対策）

### 4.1 学習率の固定化・低減

- 現象: step増加で loss 発散
- 対策:
  - learning_rate を **1e-4 → 3e-5** 程度まで低減

### 4.2 clip_range の明示設定

```
PPO(
  clip_range=0.1,
  n_steps=2048,
  batch_size=256
)
```

- clipが大きいと policy が一気に壊れる

### 4.3 entropy_coef の抑制

- 探索過多 → 実走行で暴れる

```
entropy_coef = 0.001 〜 0.0001
```

---

## 5. 学習・実走行の分離戦略

### 5.1 学習時

- 観測: LiDAR + 残差 + frame stack
- action: 残差action
- ノイズあり

### 5.2 実走行時（Jetson）

- 観測正規化を固定
- action出力に **rate limiter** を追加

---

## 6. 優先実装ロードマップ

1. LiDAR 540次元化 + 残差観測
2. Action残差化
3. FrameStack導入
4. PPOハイパラ調整
5. Jetson用 action smoothing

---

## 結論

- 報酬関数を触らなくても、
- **観測・行動・時間・学習安定性** の4点で
- 走行性能は大きく改善可能

特に、
> **残差処理 × 540次元LiDAR × Action差分**

は、シミュレーションから実機へ橋渡しするための核心設計である。

